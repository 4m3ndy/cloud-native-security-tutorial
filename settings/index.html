


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Getting started with cloud native security">
      
      
      
        <meta name="author" content="Liz Rice and Michael Hausenblas">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.4.0">
    
    
      
        <title>Secure settings - Cloud Native Security Tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.fe0cca5b.min.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/palette.a46bcfb3.min.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,400i,700%7CPT+Mono&display=fallback">
        <style>body,input{font-family:"Lato",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"PT Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#using-secure-kubernetes-settings" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Cloud Native Security Tutorial" class="md-header-nav__button md-logo" aria-label="Cloud Native Security Tutorial">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17a2 2 0 002-2 2 2 0 00-2-2 2 2 0 00-2 2 2 2 0 002 2m6-9a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V10a2 2 0 012-2h1V6a5 5 0 015-5 5 5 0 015 5v2h1m-6-5a3 3 0 00-3 3v2h6V6a3 3 0 00-3-3z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Cloud Native Security Tutorial
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Secure settings
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/k8s-sec/cloud-native-security-tutorial/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    k8s-sec/cloud-native-security-tutorial
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

  

<nav class="md-tabs md-tabs--active" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href=".." class="md-tabs__link">
          Home
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../compromise/" class="md-tabs__link md-tabs__link--active">
          Exercises
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../conclusions/" class="md-tabs__link">
          Conclusion
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cloud Native Security Tutorial" class="md-nav__button md-logo" aria-label="Cloud Native Security Tutorial">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17a2 2 0 002-2 2 2 0 00-2-2 2 2 0 00-2 2 2 2 0 002 2m6-9a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V10a2 2 0 012-2h1V6a5 5 0 015-5 5 5 0 015 5v2h1m-6-5a3 3 0 00-3 3v2h6V6a3 3 0 00-3-3z"/></svg>

    </a>
    Cloud Native Security Tutorial
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/k8s-sec/cloud-native-security-tutorial/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    k8s-sec/cloud-native-security-tutorial
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Home
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Home" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Home
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../introduction/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../preparation/" title="Preparation" class="md-nav__link">
      Preparation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Exercises
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Exercises" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Exercises
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../compromise/" title="Compromised pod" class="md-nav__link">
      Compromised pod
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../scanning/" title="Scanning" class="md-nav__link">
      Scanning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../policies/" title="Policies" class="md-nav__link">
      Policies
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Secure settings
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Secure settings" class="md-nav__link md-nav__link--active">
      Secure settings
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-cis-kubernetes-benchmark" class="md-nav__link">
    The CIS Kubernetes Benchmark
  </a>
  
    <nav class="md-nav" aria-label="The CIS Kubernetes Benchmark">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-benchmark-checks-with-kube-bench" class="md-nav__link">
    Running benchmark checks with kube-bench
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-kube-bench-in-kind" class="md-nav__link">
    Run kube-bench in kind
  </a>
  
    <nav class="md-nav" aria-label="Run kube-bench in kind">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-kube-bench-job" class="md-nav__link">
    Create kube-bench job
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-job-output-from-logs" class="md-nav__link">
    Get job output from logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remediate-a-test" class="md-nav__link">
    Remediate a test
  </a>
  
    <nav class="md-nav" aria-label="Remediate a test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#edit-kubelet-configuration" class="md-nav__link">
    Edit kubelet configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re-run-kube-bench" class="md-nav__link">
    Re-run kube-bench
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-kube-bench-via-starboard" class="md-nav__link">
    Using kube-bench via Starboard
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-exercises" class="md-nav__link">
    Optional exercises
  </a>
  
    <nav class="md-nav" aria-label="Optional exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-a-specific-test" class="md-nav__link">
    Run a specific test
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specify-worker-node-tests-only" class="md-nav__link">
    Specify worker node tests only
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gitops/" title="GitOps" class="md-nav__link">
      GitOps
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Conclusion
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Conclusion" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Conclusion
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../conclusions/" title="Conclusions" class="md-nav__link">
      Conclusions
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-cis-kubernetes-benchmark" class="md-nav__link">
    The CIS Kubernetes Benchmark
  </a>
  
    <nav class="md-nav" aria-label="The CIS Kubernetes Benchmark">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-benchmark-checks-with-kube-bench" class="md-nav__link">
    Running benchmark checks with kube-bench
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-kube-bench-in-kind" class="md-nav__link">
    Run kube-bench in kind
  </a>
  
    <nav class="md-nav" aria-label="Run kube-bench in kind">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-kube-bench-job" class="md-nav__link">
    Create kube-bench job
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-job-output-from-logs" class="md-nav__link">
    Get job output from logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remediate-a-test" class="md-nav__link">
    Remediate a test
  </a>
  
    <nav class="md-nav" aria-label="Remediate a test">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#edit-kubelet-configuration" class="md-nav__link">
    Edit kubelet configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#re-run-kube-bench" class="md-nav__link">
    Re-run kube-bench
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-kube-bench-via-starboard" class="md-nav__link">
    Using kube-bench via Starboard
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-exercises" class="md-nav__link">
    Optional exercises
  </a>
  
    <nav class="md-nav" aria-label="Optional exercises">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#run-a-specific-test" class="md-nav__link">
    Run a specific test
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specify-worker-node-tests-only" class="md-nav__link">
    Specify worker node tests only
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/k8s-sec/cloud-native-security-tutorial/edit/master/docs/settings.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="using-secure-kubernetes-settings">Using secure Kubernetes settings<a class="headerlink" href="#using-secure-kubernetes-settings" title="Permanent link">&para;</a></h1>
<p>When you install Kubernetes, there are numerous configuration settings that can affect security. In this section you'll learn about checking the settings in your cluster against the best practices advised by the Center for Internet Security.</p>
<h2 id="the-cis-kubernetes-benchmark">The CIS Kubernetes Benchmark<a class="headerlink" href="#the-cis-kubernetes-benchmark" title="Permanent link">&para;</a></h2>
<p>The CIS have many different benchmarks recommending how to configure software components with security best practices in mind. One such benchmark is for Kubernetes - in fact there are several editions for managed version of Kubernetes, like EKS or GKE, as well as for upstream Kubernetes installations.</p>
<p>There are hundreds of recommendations in these benchmarks, so running them manually on every node would be a time-consuming process.</p>
<h3 id="running-benchmark-checks-with-kube-bench">Running benchmark checks with kube-bench<a class="headerlink" href="#running-benchmark-checks-with-kube-bench" title="Permanent link">&para;</a></h3>
<p>The open source tool <a href="https://github.com/aquasecurity/kube-bench">kube-bench</a> makes it easy to run the tests defined in the CIS Kubernetes benchmark. In this tutorial, you will use kube-bench to identify some insecure Kubernetes settings, and you'll remediate one of the settings to turn a failing test into a pass.</p>
<p>You could run <code>kube-bench</code> in a cluster of your choice but for this tutorial we are showing it running in a kind (Kubernetes in Docker) single-node cluster that runs on your laptop as a Docker container.</p>
<h2 id="run-kube-bench-in-kind">Run kube-bench in kind<a class="headerlink" href="#run-kube-bench-in-kind" title="Permanent link">&para;</a></h2>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>What we are about to do is TERRIBLE practice but it makes it easier to write a platform-independent set of instructions for this tutorial. Never run YAML directly from the internet like this in your production cluster - check what's in it first!</p>
</div>
<h3 id="create-kube-bench-job">Create kube-bench job<a class="headerlink" href="#create-kube-bench-job" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl apply -f https://raw.githubusercontent.com/aquasecurity/kube-bench/master/job.yaml</span>
</code></pre></div>
</td></tr></table>

<p>You can watch the job until it has completed:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl get jobs --watch</span>
</code></pre></div>
</td></tr></table>

<p>Hit Ctrl-C once the job has finished.</p>
<h3 id="get-job-output-from-logs">Get job output from logs<a class="headerlink" href="#get-job-output-from-logs" title="Permanent link">&para;</a></h3>
<p>The job applies the label <code>app: kube-bench</code> to the pod, so you can easily retrieve the logs like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl logs $(kubectl get pods -l app=kube-bench -o name)</span>
</code></pre></div>
</td></tr></table>

<p>Scroll back through the logs to see how it is divided into sections, each with its own set of results, remediation recommendations, and a summary.</p>
<p>Most of the tests pass but there are a few results marked with <code>[WARN]</code> or <code>[FAIL]</code></p>
<ul>
<li><code>[FAIL]</code> means that the test failed</li>
<li><code>[WARN]</code> indicates that you need to do something manually to verify whether the test should pass or not.</li>
</ul>
<p>For more detail on the output check the <a href="https://github.com/aquasecurity/kube-bench#output">kube-bench documentation</a>.</p>
<h2 id="remediate-a-test">Remediate a test<a class="headerlink" href="#remediate-a-test" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This tutorial was written using Kubernetes 1.18.2 and testing against the CIS Kubernetes Benchmark v1.5.1. If you are using a later version of Kubernetes, it's possible that the default configuration settings have changed and the results you get might not match what is described here.</p>
</div>
<p>Scroll back through the results to find the result and (further down the results) the remediation information for the test 4.2.6.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="p">...</span><span class="w"></span>

<span class="o">[</span><span class="n">FAIL</span><span class="o">]</span><span class="w"> </span><span class="mf">4.2.6</span><span class="w"> </span><span class="n">Ensure</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="c1">--protect-kernel-defaults argument is set to true (Scored)</span>

<span class="p">...</span><span class="w"></span>

<span class="mf">4.2.6</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">Kubelet</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="k">file</span><span class="p">,</span><span class="w"> </span><span class="n">edit</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="nl">protectKernelDefaults</span><span class="p">:</span><span class="w"> </span><span class="k">true</span><span class="p">.</span><span class="w"></span>
<span class="k">If</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="n">arguments</span><span class="p">,</span><span class="w"> </span><span class="n">edit</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">kubelet</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="k">file</span><span class="w"></span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">kubelet</span><span class="p">.</span><span class="n">service</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="n">kubeadm</span><span class="p">.</span><span class="n">conf</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">each</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="ow">and</span><span class="w"></span>
<span class="k">set</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">below</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">KUBELET_SYSTEM_PODS_ARGS</span><span class="w"> </span><span class="k">variable</span><span class="p">.</span><span class="w"></span>
<span class="c1">--protect-kernel-defaults=true</span>
<span class="n">Based</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="k">system</span><span class="p">,</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">kubelet</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="w"> </span><span class="k">For</span><span class="w"> </span><span class="nl">example</span><span class="p">:</span><span class="w"></span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">daemon</span><span class="o">-</span><span class="n">reload</span><span class="w"></span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">kubelet</span><span class="p">.</span><span class="n">service</span><span class="w"></span>
</code></pre></div>
</td></tr></table>

<p>Kind uses a kubelet configuration file that lives at <code>/var/lib/kubelet/config.yaml</code>, so only the first line of the remediation text applies - you don't have to worry about editing the kubelet service file or restarting the service.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When using kind, there is a Docker container running your control plane. This image for this container is based on Ubuntu so we can exec into the running container and then treat it much as if it were a virtual machine running a Kubernetes node.</p>
</div>
<h3 id="edit-kubelet-configuration">Edit kubelet configuration<a class="headerlink" href="#edit-kubelet-configuration" title="Permanent link">&para;</a></h3>
<p>First, open a shell into the kind container.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">docker exec -it kind-control-plane bash</span>
</code></pre></div>
</td></tr></table>

<p>Assuming that it doesn't already have an editor installed, you can add one.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">apt-get update</span>
<span class="err">apt-get install vim</span>
</code></pre></div>
</td></tr></table>

<p>Edit the Kubelet config file</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">vi /var/lib/kubelet/config.yaml</span>
</code></pre></div>
</td></tr></table>

<p>Add the line <code>protectKernelDefaults: true</code> so that the file looks something like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="n">apiVersion</span><span class="o">:</span> <span class="n">kubelet</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">k8s</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">authentication</span><span class="o">:</span>
  <span class="n">anonymous</span><span class="o">:</span>
    <span class="n">enabled</span><span class="o">:</span> <span class="kc">false</span>
<span class="o">...</span>
<span class="n">nodeStatusUpdateFrequency</span><span class="o">:</span> <span class="mi">0</span><span class="n">s</span>
<span class="n">protectKernelDefaults</span><span class="o">:</span> <span class="kc">true</span>
<span class="n">rotateCertificates</span><span class="o">:</span> <span class="kc">true</span>
<span class="o">...</span>
</code></pre></div>
</td></tr></table>

<p>Save the file. The kubelet will spot that the configuration has changed and update itself, but meanwhile you can <code>exit</code> to leave the container so that you are back at your terminal where you can run <code>kubectl</code> commands on the kind cluster.</p>
<h3 id="re-run-kube-bench">Re-run kube-bench<a class="headerlink" href="#re-run-kube-bench" title="Permanent link">&para;</a></h3>
<p>First delete the previous job:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl delete job kube-bench</span>
</code></pre></div>
</td></tr></table>

<p>Run the kube-bench job, as before:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl apply -f https://raw.githubusercontent.com/aquasecurity/kube-bench/master/job.yaml</span>
</code></pre></div>
</td></tr></table>

<p>Once the job has completed, get the test results from the logs</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code><span class="err">kubectl logs $(kubectl get pods -l app=kube-bench -o name)</span>
</code></pre></div>
</td></tr></table>

<p>This time you should see that test 4.2.6 passes. Congratulations, you have remediated a security setting on a Kubernetes node!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This only remediates the running node, of course! If you are managing your own Kubernetes nodes, it would be better to update the configuration settings you use in deployment scripts, so that the nodes are configured to run from the outset with the settings you want.</p>
</div>
<h2 id="using-kube-bench-via-starboard">Using kube-bench via Starboard<a class="headerlink" href="#using-kube-bench-via-starboard" title="Permanent link">&para;</a></h2>
<p>You can also use Starboard to run kube-bench and store the results in a Kubernetes CRD.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>kubectl starboard kube-bench
kubectl get ciskubebenchreports -o yaml
</code></pre></div>
</td></tr></table>

<p>These results can be easily viewed using Octant and the Octant Starboard plugin.</p>
<p>Using Starboard has the advantage that it will automatically run a <code>kube-bench</code> job on all the nodes in the cluster.</p>
<p><img alt="Octant deployment page showing CIS Kubernetes Benchmark results" src="../img/octant-kube-bench.png" /></p>
<h2 id="optional-exercises">Optional exercises<a class="headerlink" href="#optional-exercises" title="Permanent link">&para;</a></h2>
<p>If you download the <a href="https://raw.githubusercontent.com/aquasecurity/kube-bench/master/job.yaml"><code>job.yaml</code></a> file used above, you can modify it to try some optional exercises.</p>
<h3 id="run-a-specific-test">Run a specific test<a class="headerlink" href="#run-a-specific-test" title="Permanent link">&para;</a></h3>
<p>Sometimes you might want to run an individual test rather than the whole benchmark. For example, try to modify the command run in the job so that it only runs the test 4.2.6 that you remediated earlier. You can do this by specifying <code>--check=4.2.6</code> as a parameter to the <code>kube-bench</code> command.</p>
<h3 id="specify-worker-node-tests-only">Specify worker node tests only<a class="headerlink" href="#specify-worker-node-tests-only" title="Permanent link">&para;</a></h3>
<p>There are different CIS Kubernetes Benchmark tests for different node types in the cluster (control plane nodes, worker nodes, etcd nodes). On a managed Kubernetes system you might only have access to worker nodes, so you only need to run the tests that apply to those nodes. <code>kube-bench</code> tries to auto-detect which tests to run on any given node, but to keep things simple you may wish to specify worker node tests only. You might like to try out the <a href="https://raw.githubusercontent.com/aquasecurity/kube-bench/master/job-node.yaml"><code>job-node.yaml</code></a> configuration which does just that.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../policies/" title="Policies" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Policies
              </div>
            </div>
          </a>
        
        
          <a href="../gitops/" title="GitOps" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                GitOps
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; Liz Rice and Michael Hausenblas
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="../assets/javascripts/bundle.b39636ac.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ["tabs", "instant"],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.a68abb33.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>